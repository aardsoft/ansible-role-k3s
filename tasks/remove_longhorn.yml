# this is essentially https://longhorn.io/docs/1.8.1/deploy/uninstall/#uninstalling-longhorn-using-kubectl
# with files pulled by the pull-longhorn-files script

- name: remove longhorn
  kubernetes.core.k8s:
    kubeconfig: "{{_k3s_kubecfg}}"
    state: present
    definition: "{{lookup('file', 'files/longhorn/uninstall.yaml')}}"
  ignore_errors: true

- name: wait for longhorn-uninstall job to complete
  kubernetes.core.k8s_info:
    kubeconfig: "{{_k3s_kubecfg}}"
    namespace: longhorn-system
    name: longhorn-uninstall
    kind: Job
    api_version: batch/v1
  register: _longhorn_uninstall_job
  retries: 30
  delay: 10
  until: >
    _longhorn_uninstall_job.resources | length > 0 and
    (_longhorn_uninstall_job.resources[0].status.conditions | default([]) |
     selectattr('type', 'equalto', 'Complete') |
     selectattr('status', 'equalto', 'True') | list | length > 0)
  ignore_errors: true

- name: remove remaining references
  kubernetes.core.k8s:
    kubeconfig: "{{_k3s_kubecfg}}"
    state: absent
    definition: "{{lookup('file', 'files/longhorn/'+def+'.yaml')}}"
  loop_control:
    loop_var: def
  with_items:
    - uninstall
    - longhorn
  ignore_errors: true
