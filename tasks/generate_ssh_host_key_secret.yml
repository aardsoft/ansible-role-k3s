# Generates an Ed25519 SSH host key pair and stores it in a Kubernetes Secret.
# Called with _gen_secret loop variable: {name: <secret-name>, generate: ssh-host-keys}
# Idempotent: if the Secret already exists in the cluster it is left unchanged.
#
# This also serves as example for other secret generators we may add later on.

- name: check if SSH host key secret already exists
  kubernetes.core.k8s_info:
    kubeconfig: "{{_k3s_kubecfg}}"
    kind: Secret
    namespace: "{{_pod_namespace}}"
    name: "{{_gen_secret.name}}"
  register: _ssh_key_secret_existing

- name: create temp directory for key generation
  ansible.builtin.tempfile:
    state: directory
    prefix: "ansible-k3s-ssh-"
  register: _ssh_key_tmpdir
  delegate_to: localhost
  vars:
    ansible_connection: local
  become: false
  when: _ssh_key_secret_existing.resources | length == 0

- name: generate Ed25519 SSH host key pair
  ansible.builtin.command:
    cmd: "ssh-keygen -t ed25519 -f {{_ssh_key_tmpdir.path}}/ssh_host_ed25519_key -N '' -C '{{_pod_name}}'"
  delegate_to: localhost
  vars:
    ansible_connection: local
  become: false
  when: _ssh_key_secret_existing.resources | length == 0

- name: slurp private key
  ansible.builtin.slurp:
    src: "{{_ssh_key_tmpdir.path}}/ssh_host_ed25519_key"
  register: _ssh_host_ed25519_key
  delegate_to: localhost
  vars:
    ansible_connection: local
  become: false
  when: _ssh_key_secret_existing.resources | length == 0

- name: slurp public key
  ansible.builtin.slurp:
    src: "{{_ssh_key_tmpdir.path}}/ssh_host_ed25519_key.pub"
  register: _ssh_host_ed25519_key_pub
  delegate_to: localhost
  vars:
    ansible_connection: local
  become: false
  when: _ssh_key_secret_existing.resources | length == 0

- name: create SSH host key Secret
  kubernetes.core.k8s:
    kubeconfig: "{{_k3s_kubecfg}}"
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: "{{_gen_secret.name}}"
        namespace: "{{_pod_namespace}}"
        labels:
          app: "{{_pod_name}}"
          configurator: ansible
        annotations:
          ansible.run-id: "{{ansible_run_id|default('N/A')}}"
          ansible.config_file: "{{ansible_config_file|default('N/A')}}"
          ansible.version: "{{ansible_version.full}}"
      data:
        ssh_host_ed25519_key: "{{_ssh_host_ed25519_key.content}}"
        ssh_host_ed25519_key.pub: "{{_ssh_host_ed25519_key_pub.content}}"
  when: _ssh_key_secret_existing.resources | length == 0

- name: remove temp directory
  ansible.builtin.file:
    path: "{{_ssh_key_tmpdir.path}}"
    state: absent
  delegate_to: localhost
  vars:
    ansible_connection: local
  become: false
  when: _ssh_key_tmpdir is defined and _ssh_key_tmpdir.path is defined
